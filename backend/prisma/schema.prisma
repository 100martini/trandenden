generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id               Int       @id @default(autoincrement())
  intraId          Int       @unique
  login            String    @unique
  displayName      String?
  email            String?
  avatar           String?
  campus           String?
  level            Float     @default(0)
  wallet           Int       @default(0)
  correctionPoints Int       @default(0)
  curriculum       String    @default("old")
  grade            String    @default("Cadet")
  currentCircle    Int       @default(0)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  createdTeams     Team[]        @relation("TeamCreator")
  teamMemberships  TeamMember[]
  userProjects     UserProject[]

  @@index([intraId])
  @@index([login])
  @@index([curriculum])
}

model Curriculum {
  id          Int       @id @default(autoincrement())
  name        String    @unique
  displayName String
  createdAt   DateTime  @default(now())

  projectCurricula ProjectCurriculum[]
}

model Project {
  id          Int       @id @default(autoincrement())
  slug        String    @unique
  name        String
  circle      Int
  minTeam     Int       @default(1)
  maxTeam     Int       @default(1)
  isOuterCore Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  projectCurricula ProjectCurriculum[]
  teams            Team[]
  userProjects     UserProject[]

  @@index([slug])
  @@index([circle])
  @@index([isOuterCore])
}

model ProjectCurriculum {
  id           Int        @id @default(autoincrement())
  projectId    Int
  curriculumId Int

  project    Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  curriculum Curriculum @relation(fields: [curriculumId], references: [id], onDelete: Cascade)

  @@unique([projectId, curriculumId])
  @@index([projectId])
  @@index([curriculumId])
}

model Team {
  id        Int       @id @default(autoincrement())
  name      String
  projectId Int
  creatorId Int
  status    String    @default("pending")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)
  creator User    @relation("TeamCreator", fields: [creatorId], references: [id], onDelete: Cascade)
  members TeamMember[]

  @@index([projectId])
  @@index([creatorId])
  @@index([status])
}

model TeamMember {
  id        Int       @id @default(autoincrement())
  teamId    Int
  userId    Int
  status    String    @default("pending")
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([teamId, userId])
  @@index([teamId])
  @@index([userId])
  @@index([status])
}

model UserProject {
  id        Int       @id @default(autoincrement())
  userId    Int
  projectId Int
  status    String
  validated Boolean   @default(false)
  finalMark Int?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@index([userId])
  @@index([projectId])
}